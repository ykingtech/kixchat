<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kix Chat v9 - Ultimate</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --accent-primary: #f43f5e;
            --msg-sent: #f43f5e;
            --msg-received: #334155;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f8fafc; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none; /* App-like feel */
        }
        
        #app-container { display: flex; flex: 1; height: 100%; overflow: hidden; position: relative; }
        #chat-area { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        #messages-container { flex: 1; overflow-y: auto; scroll-behavior: smooth; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 16px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; position: relative; }
        .sent { background-color: var(--msg-sent); color: white; border-bottom-right-radius: 2px; align-self: flex-end; }
        .received { background-color: var(--msg-received); color: white; border-bottom-left-radius: 2px; align-self: flex-start; }
        
        .sticker-msg { background: transparent !important; padding: 0 !important; font-size: 4rem; box-shadow: none !important; }
        .sticker-bounce { animation: bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .chat-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .chat-item.active { background-color: rgba(244, 63, 94, 0.1); border-left: 3px solid #f43f5e; }

        .unread-badge { background: #22c55e; color: black; font-weight: bold; font-size: 10px; padding: 2px 6px; border-radius: 999px; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Context Menu */
        .context-menu {
            position: absolute; z-index: 1000; background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden;
            animation: scaleIn 0.1s ease-out; transform-origin: top left;
        }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .context-item { padding: 10px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: #cbd5e1; font-size: 0.9rem; }
        .context-item:hover { background: #334155; color: white; }
        .context-item.danger { color: #f87171; }

        /* Lightbox */
        #lightbox { transition: opacity 0.3s; }
        #lightbox.hidden { opacity: 0; pointer-events: none; }
        #lightbox:not(.hidden) { opacity: 1; pointer-events: auto; }

        /* Ticks */
        .tick { font-size: 14px; margin-left: 4px; }
        .tick.blue { color: #60a5fa; }
        .tick.gray { color: #94a3b8; }

        .tab-btn { @apply flex-1 py-2 text-sm font-medium text-slate-400 border-b-2 border-transparent transition-all; }
        .tab-btn.active { @apply text-rose-500 border-rose-500; }

        @media (max-width: 640px) {
            .chat-bubble { font-size: 0.9rem; }
            #input-tools button i { font-size: 1.2rem; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- LIGHTBOX (Image Popup) -->
    <div id="lightbox" class="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center hidden" onclick="closeLightbox()">
        <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain p-2">
        <button class="absolute top-4 right-4 text-white p-2 bg-black/50 rounded-full"><i class="ph-bold ph-x text-2xl"></i></button>
    </div>

    <!-- MESSAGE CONTEXT MENU -->
    <div id="msg-context-menu" class="context-menu hidden">
        <!-- Dynamic content -->
    </div>

    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-[#0f172a]">
        <div class="flex justify-center mb-6 animate-pulse">
            <img src="logo.png" class="w-24 h-24 rounded-3xl shadow-2xl object-cover" onerror="this.src='https://ui-avatars.com/api/?name=Kix&background=f43f5e&color=fff&size=128'">
        </div>
        <h1 class="text-2xl font-bold text-white tracking-widest mb-2">KIX CHAT</h1>
        <div class="flex gap-2 mt-4">
            <div class="w-2 h-2 bg-rose-500 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-rose-500 rounded-full animate-bounce delay-100"></div>
            <div class="w-2 h-2 bg-rose-500 rounded-full animate-bounce delay-200"></div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-[#0f172a] p-6">
        <h1 class="text-3xl font-bold mb-2">Welcome Back</h1>
        <p class="text-slate-400 text-sm mb-8">Secure messaging for everyone.</p>
        <button onclick="signInWithGoogle()" class="w-full max-w-xs bg-white text-slate-900 font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 transition-all shadow-lg">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
            Sign in with Google
        </button>
    </div>

    <!-- MAIN APP -->
    <div id="app-interface" class="hidden w-full h-full flex flex-col overflow-hidden">
        
        <div id="app-container">
            <!-- SIDEBAR -->
            <div class="w-full md:w-80 bg-[#1e293b] border-r border-slate-700/30 flex flex-col z-20 h-full flex-none" id="sidebar">
                <div class="p-4 border-b border-slate-700/30 bg-[#1e293b] shrink-0 space-y-3">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <img id="my-avatar" src="" class="w-9 h-9 rounded-full border border-slate-600">
                            <div>
                                <h2 class="font-bold text-sm">Kix Chat</h2>
                                <div class="flex items-center gap-1 text-[10px] text-green-400">‚óè Online</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showCreateGroupModal()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-rose-500 flex items-center justify-center"><i class="ph-bold ph-users-three"></i></button>
                            <button onclick="showAddFriendModal()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-rose-500 flex items-center justify-center"><i class="ph-bold ph-plus"></i></button>
                        </div>
                    </div>
                    <div class="flex border-b border-slate-700">
                        <button id="tab-chats" onclick="switchTab('chats')" class="tab-btn active">Chats</button>
                        <button id="tab-groups" onclick="switchTab('groups')" class="tab-btn">Groups</button>
                    </div>
                </div>
                <div id="list-container" class="flex-1 overflow-y-auto p-2 space-y-1 relative"></div>
            </div>

            <!-- CHAT AREA -->
            <div class="flex-1 flex flex-col bg-[#0f172a] relative hidden md:flex h-full min-w-0" id="chat-area">
                
                <!-- Active Chat -->
                <div id="active-chat-interface" class="hidden flex flex-col h-full w-full relative">
                    <!-- Header -->
                    <div class="h-16 border-b border-slate-700/30 flex items-center justify-between px-3 bg-[#1e293b]/90 backdrop-blur-md shrink-0 z-10 w-full cursor-pointer" onclick="showChatInfo()">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <button onclick="event.stopPropagation(); backToSidebar()" class="md:hidden text-slate-400 p-1"><i class="ph-bold ph-arrow-left text-xl"></i></button>
                            <img id="chat-header-img" src="" class="w-8 h-8 rounded-full bg-slate-700 shrink-0 object-cover">
                            <div class="min-w-0">
                                <h3 id="chat-header-name" class="font-bold text-sm text-white truncate">User</h3>
                                <p id="chat-header-status" class="text-[10px] text-slate-400 truncate">Tap for info</p>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div id="messages-container" class="flex-1 overflow-y-auto p-3 space-y-3 flex flex-col w-full"></div>

                    <!-- Input Area -->
                    <div id="input-area-wrapper" class="p-2 bg-[#1e293b] border-t border-slate-700/30 shrink-0 w-full z-20">
                        <div id="admin-only-banner" class="hidden text-center text-xs text-rose-400 py-2 bg-rose-900/10 rounded mb-1 border border-rose-900/30">Only admins can send messages</div>
                        
                        <div id="main-input-bar">
                            <!-- Image Preview -->
                            <div id="image-preview-container" class="hidden mb-2 p-2 bg-slate-800 rounded-lg w-fit relative">
                                <img id="image-preview" src="" class="h-14 rounded border border-slate-600">
                                <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5"><i class="ph-bold ph-x text-xs"></i></button>
                            </div>

                            <!-- Editing Indicator -->
                            <div id="editing-indicator" class="hidden flex justify-between items-center bg-slate-800 p-2 rounded mb-2 text-xs">
                                <span class="text-blue-400">Editing message...</span>
                                <button onclick="cancelEdit()" class="text-slate-400"><i class="ph-bold ph-x"></i></button>
                            </div>

                            <div class="flex items-center gap-2 w-full">
                                <button onclick="toggleStickerPicker()" class="p-2 text-slate-400 hover:text-yellow-400 shrink-0"><i class="ph-fill ph-smiley text-2xl"></i></button>
                                <label class="p-2 text-slate-400 hover:text-rose-500 cursor-pointer shrink-0"><i class="ph-bold ph-image text-2xl"></i><input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageSelect(event)"></label>
                                
                                <div class="flex-1 relative min-w-0">
                                    <input id="message-input" type="text" class="w-full bg-[#0f172a] border border-slate-600 rounded-full px-4 py-2.5 text-sm text-white focus:border-rose-500 outline-none transition-all placeholder-slate-500" placeholder="Message...">
                                </div>
                                
                                <button onclick="sendMessage()" id="send-btn" class="w-10 h-10 bg-rose-500 hover:bg-rose-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-95 shrink-0"><i class="ph-fill ph-paper-plane-right text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sticker Picker -->
                    <div id="sticker-picker" class="hidden absolute bottom-16 left-2 bg-[#1e293b] border border-slate-700 rounded-xl shadow-2xl p-3 w-72 h-64 overflow-y-auto z-50">
                        <div class="flex gap-2 border-b border-slate-700 pb-2 mb-2">
                            <button onclick="showStickerTab('default')" class="text-xs text-slate-300 hover:text-white flex-1">Emojis</button>
                            <button onclick="showStickerTab('saved')" class="text-xs text-rose-400 hover:text-rose-300 flex-1 font-bold">My Stickers</button>
                        </div>
                        <div id="sticker-content-default" class="grid grid-cols-4 gap-2">
                            <!-- Standard Emojis -->
                            <button onclick="sendSticker('üëª')" class="text-2xl hover:bg-white/10 p-1 rounded">üëª</button>
                            <button onclick="sendSticker('üî•')" class="text-2xl hover:bg-white/10 p-1 rounded">üî•</button>
                            <button onclick="sendSticker('‚ù§Ô∏è')" class="text-2xl hover:bg-white/10 p-1 rounded">‚ù§Ô∏è</button>
                            <button onclick="sendSticker('üòÇ')" class="text-2xl hover:bg-white/10 p-1 rounded">üòÇ</button>
                            <button onclick="sendSticker('üëç')" class="text-2xl hover:bg-white/10 p-1 rounded">üëç</button>
                        </div>
                        <div id="sticker-content-saved" class="grid grid-cols-3 gap-2 hidden">
                            <!-- Saved Stickers -->
                            <div class="col-span-3 text-center text-xs text-slate-500 mt-4">Save images as stickers to see them here!</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- GROUP INFO / SETTINGS MODAL -->
    <div id="group-settings-modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1e293b] rounded-2xl p-6 w-full max-w-sm border border-slate-700 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 flex justify-between items-center">
                <span>Group Settings</span>
                <button onclick="document.getElementById('group-settings-modal').classList.add('hidden')" class="text-slate-400"><i class="ph-bold ph-x"></i></button>
            </h3>
            
            <div id="admin-controls" class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-[#0f172a] rounded-lg">
                    <div class="text-sm">
                        <div class="font-medium text-white">Only Admins Send</div>
                        <div class="text-xs text-slate-400">Restrict members from posting</div>
                    </div>
                    <input type="checkbox" id="toggle-admin-only" onchange="toggleAdminOnly()" class="accent-rose-500 w-5 h-5">
                </div>
                
                <div class="text-xs text-slate-500 uppercase font-bold mt-4 mb-2">Members</div>
                <div id="group-members-list" class="max-h-40 overflow-y-auto space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="add-friend-modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1e293b] rounded-2xl p-6 w-full max-w-sm border border-slate-700">
            <h3 class="text-lg font-bold mb-4">New Chat</h3>
            <input type="email" id="friend-email" placeholder="Gmail address..." class="w-full bg-[#0f172a] border border-slate-600 rounded-lg p-3 text-white mb-4 text-sm outline-none focus:border-rose-500">
            <div class="flex gap-2 justify-end">
                <button onclick="closeModals()" class="px-4 py-2 text-slate-400 text-sm">Cancel</button>
                <button onclick="startChat()" class="px-4 py-2 bg-rose-500 text-white rounded-lg text-sm">Start</button>
            </div>
        </div>
    </div>

    <div id="create-group-modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1e293b] rounded-2xl p-6 w-full max-w-sm border border-slate-700 space-y-4">
            <h3 class="text-lg font-bold">Create Group</h3>
            <input type="text" id="group-name" placeholder="Group Name" class="w-full bg-[#0f172a] border border-slate-600 rounded-lg p-3 text-white text-sm outline-none">
            <select id="group-category" class="w-full bg-[#0f172a] border border-slate-600 rounded-lg p-3 text-white text-sm outline-none">
                <option value="general">General</option>
                <option value="tech">Technology</option>
                <option value="fun">Fun</option>
            </select>
            <div class="flex items-center gap-2 bg-[#0f172a] border border-slate-600 rounded-lg px-3 p-2">
                <input type="checkbox" id="group-public" class="accent-rose-500 w-4 h-4">
                <label for="group-public" class="text-sm text-slate-300">Public Group</label>
            </div>
            <div class="flex gap-2 justify-end pt-2">
                <button onclick="closeModals()" class="px-4 py-2 text-slate-400 text-sm">Cancel</button>
                <button onclick="createGroup()" class="px-4 py-2 bg-rose-500 text-white rounded-lg text-sm">Create</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, query, where, getDocs, onSnapshot, serverTimestamp, updateDoc, increment, orderBy, deleteDoc, writeBatch, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCz8xJ5Qb7m5cjYWs9SqxpdtnZymYLiblI",
            authDomain: "kix-chatmass.firebaseapp.com",
            projectId: "kix-chatmass",
            storageBucket: "kix-chatmass.firebasestorage.app",
            messagingSenderId: "796961974964",
            appId: "1:796961974964:web:65c536e2a521b28e56c5e1",
            measurementId: "G-CPZC0E6HD7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentChatId = null;
        let currentChatData = null;
        let selectedImageBase64 = null;
        let unsubscribeMessages = null;
        let currentTab = 'chats';
        let editingMessageId = null;

        // AUTH
        window.signInWithGoogle = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('splash-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('my-avatar').src = user.photoURL;
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid, email: user.email, displayName: user.displayName, 
                    photoURL: user.photoURL, lastSeen: serverTimestamp()
                }, { merge: true });
                loadLists();
                loadSavedStickers();
            } else {
                document.getElementById('splash-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
        });

        // TABS
        window.switchTab = (tab) => {
            currentTab = tab;
            document.getElementById('tab-chats').className = `tab-btn ${tab === 'chats' ? 'active' : ''}`;
            document.getElementById('tab-groups').className = `tab-btn ${tab === 'groups' ? 'active' : ''}`;
            loadLists();
        }

        // LOAD LISTS
        function loadLists() {
            const listContainer = document.getElementById("list-container");
            listContainer.innerHTML = "";

            if (currentTab === 'chats') {
                const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), where("type", "==", "direct"));
                onSnapshot(q, (snapshot) => renderList(snapshot, listContainer));
            } else {
                const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), where("type", "==", "group"));
                onSnapshot(q, (snapshot) => renderList(snapshot, listContainer));
                // Public groups logic omitted for brevity, handled similarly
            }
        }

        function renderList(snapshot, container) {
            container.innerHTML = "";
            let items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => (b.lastUpdated?.toMillis() || 0) - (a.lastUpdated?.toMillis() || 0));

            items.forEach(chat => {
                let name = chat.name;
                let photo = "";
                let isGroup = chat.type === 'group';

                if (!isGroup) {
                    const otherId = chat.participants.find(id => id !== currentUser.uid) || currentUser.uid;
                    const otherUser = chat.userDetails?.[otherId] || { name: 'User' };
                    name = otherUser.name;
                    photo = otherUser.photo;
                }

                let lastMsg = chat.lastMessage || "No messages";
                if(chat.lastMessageType === 'image') lastMsg = "üì∑ Photo";
                if(chat.lastMessageType === 'sticker') lastMsg = "üëæ Sticker";

                const div = document.createElement('div');
                div.className = `chat-item p-3 rounded-xl cursor-pointer flex items-center gap-3 transition-colors ${currentChatId === chat.id ? 'active' : ''}`;
                div.onclick = () => selectChat(chat.id, { name, photo, isGroup });
                
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center overflow-hidden shrink-0">
                        ${photo ? `<img src="${photo}" class="w-full h-full object-cover">` : `<i class="ph-fill ph-${isGroup?'users-three':'user'} text-xl text-white"></i>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <h4 class="font-medium text-sm truncate text-white">${name}</h4>
                            <span class="text-[9px] text-slate-500">${chat.lastUpdated?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || ''}</span>
                        </div>
                        <p class="text-xs text-slate-400 truncate">${lastMsg}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // SELECT CHAT
        window.selectChat = async (chatId, info) => {
            currentChatId = chatId;
            // Fetch fresh chat data for settings
            const chatSnap = await getDoc(doc(db, "chats", chatId));
            currentChatData = chatSnap.data();

            // Mobile toggle
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('chat-area').classList.remove('hidden');
                document.getElementById('chat-area').classList.add('flex');
            }

            // Header Update
            document.getElementById('chat-header-name').innerText = info.name;
            document.getElementById('chat-header-img').src = info.photo || "";
            document.getElementById('chat-header-img').onerror = function(){ this.style.display='none'; };
            if(!info.photo) document.getElementById('chat-header-img').style.display='none';
            else document.getElementById('chat-header-img').style.display='block';

            document.getElementById('chat-header-status').innerText = info.isGroup ? "Group Info" : "User Info";

            // Admin Check
            checkAdminPermissions();

            // Load Messages
            if(unsubscribeMessages) unsubscribeMessages();
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("createdAt", "asc"));
            
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const container = document.getElementById("messages-container");
                container.innerHTML = "";
                
                snapshot.forEach(docSnap => {
                    const msg = { id: docSnap.id, ...docSnap.data() };
                    // Filter "Deleted for Me"
                    if(msg.deletedFor && msg.deletedFor.includes(currentUser.uid)) return;
                    renderMessage(msg, container);
                });
                
                // Mark Seen (Simple Logic: Update Chat)
                if(snapshot.docs.length > 0) {
                    const lastDoc = snapshot.docs[snapshot.docs.length -1];
                    if(lastDoc.data().senderId !== currentUser.uid) {
                        updateDoc(doc(db, "chats", chatId), { [`lastSeen.${currentUser.uid}`]: serverTimestamp() });
                    }
                }
                container.scrollTop = container.scrollHeight;
            });
        }

        function checkAdminPermissions() {
            const inputWrapper = document.getElementById('main-input-bar');
            const banner = document.getElementById('admin-only-banner');
            
            if(currentChatData.type === 'group' && currentChatData.onlyAdminsCanPost) {
                if(!currentChatData.admins.includes(currentUser.uid)) {
                    inputWrapper.classList.add('hidden');
                    banner.classList.remove('hidden');
                } else {
                    inputWrapper.classList.remove('hidden');
                    banner.classList.add('hidden');
                }
            } else {
                inputWrapper.classList.remove('hidden');
                banner.classList.add('hidden');
            }
        }

        function renderMessage(msg, container) {
            const isMe = msg.senderId === currentUser.uid;
            const div = document.createElement('div');
            div.className = `flex flex-col mb-2 ${isMe ? 'items-end' : 'items-start'} w-full group relative`;
            
            // Context Menu Trigger (Right Click or Long Press)
            div.oncontextmenu = (e) => showContextMenu(e, msg);
            // Long Press for Mobile
            let pressTimer;
            div.ontouchstart = (e) => { pressTimer = setTimeout(() => showContextMenu(e, msg), 800); };
            div.ontouchend = () => clearTimeout(pressTimer);

            let content = "";
            let statusIcon = "";

            // Status Logic (Mocked logic for demo, ideally compare timestamps)
            if(isMe) {
                // If last message in chat has been seen by others? simplified:
                statusIcon = '<i class="ph-bold ph-check tick gray"></i>'; // Sent
                // Real implementation needs to check `chat.lastSeen` map
            }

            if (msg.type === 'deleted') {
                content = `<div class="chat-bubble ${isMe ? 'bg-slate-700' : 'bg-slate-800'} text-slate-400 italic text-xs"><i class="ph-fill ph-prohibit"></i> This message was deleted</div>`;
            } else if (msg.type === 'sticker') {
                content = `<img src="${msg.imageUrl}" class="w-32 h-32 object-contain cursor-pointer hover:scale-105 transition" onclick="openLightbox('${msg.imageUrl}')">`;
            } else if (msg.imageUrl) {
                content = `<div class="chat-bubble ${isMe ? 'sent' : 'received'} p-1">
                    <img src="${msg.imageUrl}" class="rounded-lg max-w-[200px] cursor-pointer" onclick="openLightbox('${msg.imageUrl}')">
                    ${msg.text ? `<p class="mt-1 px-1 text-sm">${msg.text}</p>` : ''}
                </div>`;
            } else {
                content = `<div class="chat-bubble ${isMe ? 'sent' : 'received'}">
                    <p>${msg.text}</p>
                    ${msg.isEdited ? '<span class="text-[9px] opacity-60 block text-right">edited</span>' : ''}
                </div>`;
            }

            const time = msg.createdAt ? msg.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
            div.innerHTML = `
                ${content}
                <div class="text-[9px] text-slate-500 text-right mt-1 mr-1 flex justify-end items-center">
                    ${time} ${isMe && msg.type !== 'deleted' ? statusIcon : ''}
                </div>
            `;
            container.appendChild(div);
        }

        // CONTEXT MENU
        window.showContextMenu = (e, msg) => {
            e.preventDefault();
            const menu = document.getElementById('msg-context-menu');
            const isMe = msg.senderId === currentUser.uid;
            
            // Positioning
            let x = e.clientX || e.touches[0].clientX;
            let y = e.clientY || e.touches[0].clientY;
            
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.classList.remove('hidden');

            let html = '';
            
            // Actions
            if(msg.type !== 'deleted') {
                html += `<div class="context-item" onclick="deleteMessage('${msg.id}', 'me')"><i class="ph-bold ph-trash"></i> Delete for Me</div>`;
                
                if(isMe) {
                    html += `<div class="context-item danger" onclick="deleteMessage('${msg.id}', 'everyone')"><i class="ph-bold ph-trash-simple"></i> Delete for Everyone</div>`;
                    if(msg.type === 'text') {
                        html += `<div class="context-item" onclick="startEdit('${msg.id}', '${msg.text.replace(/'/g, "\\'")}')"><i class="ph-bold ph-pencil"></i> Edit</div>`;
                    }
                }

                if((msg.imageUrl || msg.type === 'sticker')) {
                    html += `<div class="context-item" onclick="saveSticker('${msg.imageUrl}')"><i class="ph-bold ph-star"></i> Save as Sticker</div>`;
                }
            }

            menu.innerHTML = html;

            // Close on click out
            const close = () => { menu.classList.add('hidden'); document.removeEventListener('click', close); };
            setTimeout(() => document.addEventListener('click', close), 100);
        };

        // MESSAGE ACTIONS
        window.deleteMessage = async (msgId, scope) => {
            const msgRef = doc(db, "chats", currentChatId, "messages", msgId);
            if(scope === 'everyone') {
                await updateDoc(msgRef, { type: 'deleted', text: '', imageUrl: null });
                // Update last message if it was the last one (Simplified)
                updateDoc(doc(db, "chats", currentChatId), { lastMessage: "üö´ Message deleted" });
            } else {
                await updateDoc(msgRef, { deletedFor: arrayUnion(currentUser.uid) });
            }
        };

        window.startEdit = (msgId, text) => {
            editingMessageId = msgId;
            document.getElementById('message-input').value = text;
            document.getElementById('editing-indicator').classList.remove('hidden');
            document.getElementById('message-input').focus();
        };

        window.cancelEdit = () => {
            editingMessageId = null;
            document.getElementById('message-input').value = "";
            document.getElementById('editing-indicator').classList.add('hidden');
        };

        window.saveSticker = (url) => {
            // Logic: Convert to base64 if needed, or save URL if persistent.
            // Using LocalStorage for simplicity (Note: Quota limits apply)
            let stickers = JSON.parse(localStorage.getItem('kix_stickers') || "[]");
            if(!stickers.includes(url)) {
                stickers.push(url);
                localStorage.setItem('kix_stickers', JSON.stringify(stickers));
                Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Sticker Saved!', showConfirmButton: false, timer: 1000 });
                loadSavedStickers();
            }
        };

        function loadSavedStickers() {
            const stickers = JSON.parse(localStorage.getItem('kix_stickers') || "[]");
            const container = document.getElementById('sticker-content-saved');
            if(stickers.length > 0) {
                container.innerHTML = "";
                stickers.forEach(url => {
                    const btn = document.createElement('button');
                    btn.innerHTML = `<img src="${url}" class="w-full h-16 object-contain">`;
                    btn.onclick = () => { sendSticker(null, url); }; // Send stored URL/Base64
                    container.appendChild(btn);
                });
                container.classList.remove('hidden');
                container.classList.add('grid');
            }
        }

        // GROUP ADMIN LOGIC
        window.showChatInfo = () => {
            if(currentChatData.type === 'group') {
                document.getElementById('group-settings-modal').classList.remove('hidden');
                const isAdmin = currentChatData.admins.includes(currentUser.uid);
                document.getElementById('toggle-admin-only').disabled = !isAdmin;
                document.getElementById('toggle-admin-only').checked = currentChatData.onlyAdminsCanPost;
                
                // List Members (simplified)
                const list = document.getElementById('group-members-list');
                list.innerHTML = currentChatData.participants.map(uid => {
                    const user = currentChatData.userDetails?.[uid];
                    const isUserAdmin = currentChatData.admins.includes(uid);
                    return `<div class="flex justify-between text-white text-sm p-2 bg-slate-800 rounded">
                        <span>${user?.name || 'User'} ${isUserAdmin ? 'üëë' : ''}</span>
                        ${isAdmin && !isUserAdmin ? `<button onclick="makeAdmin('${uid}')" class="text-xs text-rose-400">Make Admin</button>` : ''}
                    </div>`;
                }).join('');
            }
        };

        window.toggleAdminOnly = async () => {
            const val = document.getElementById('toggle-admin-only').checked;
            await updateDoc(doc(db, "chats", currentChatId), { onlyAdminsCanPost: val });
        };

        window.makeAdmin = async (uid) => {
            await updateDoc(doc(db, "chats", currentChatId), { admins: arrayUnion(uid) });
            showChatInfo(); // Refresh
        };

        // SEND LOGIC
        window.sendMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            const btn = document.getElementById('send-btn');

            if(!text && !selectedImageBase64) return;

            btn.disabled = true;

            // Handle EDIT
            if(editingMessageId) {
                await updateDoc(doc(db, "chats", currentChatId, "messages", editingMessageId), {
                    text: text, isEdited: true
                });
                cancelEdit();
                btn.disabled = false;
                return;
            }

            try {
                // Determine Status: In real app, cloud functions update this. Here start as 'sent'.
                const msgData = {
                    text: text,
                    imageUrl: selectedImageBase64,
                    senderId: currentUser.uid,
                    type: selectedImageBase64 ? 'image' : 'text',
                    createdAt: serverTimestamp(),
                    status: 'sent', // sent, delivered, seen
                    deletedFor: []
                };

                await addDoc(collection(db, "chats", currentChatId, "messages"), msgData);
                
                await updateDoc(doc(db, "chats", currentChatId), {
                    lastMessage: text || "Photo",
                    lastMessageType: selectedImageBase64 ? 'image' : 'text',
                    lastUpdated: serverTimestamp()
                });

                if(selectedImageBase64) clearImage();
                input.value = "";
                btn.disabled = false;
                input.focus();
            } catch(e) {
                console.error(e);
                btn.disabled = false;
            }
        };

        window.sendSticker = async (emoji, url = null) => {
            if(!currentChatId) return;
            const content = url ? null : emoji;
            const img = url ? url : null; // If url provided (saved sticker), use it
            // If Emoji sticker, we treat text as emoji, type as sticker
            
            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                text: content, imageUrl: img, senderId: currentUser.uid,
                type: 'sticker', createdAt: serverTimestamp(), status: 'sent', deletedFor: []
            });
            await updateDoc(doc(db, "chats", currentChatId), { lastMessage: "Sticker", lastMessageType: 'sticker', lastUpdated: serverTimestamp() });
            
            document.getElementById('sticker-picker').classList.add('hidden');
        };

        // UI HELPERS
        window.openLightbox = (src) => {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').classList.remove('hidden');
        };
        window.closeLightbox = () => document.getElementById('lightbox').classList.add('hidden');
        
        window.toggleStickerPicker = () => {
            document.getElementById('sticker-picker').classList.toggle('hidden');
            loadSavedStickers();
        };
        window.showStickerTab = (tab) => {
            document.getElementById('sticker-content-default').classList.toggle('hidden', tab !== 'default');
            document.getElementById('sticker-content-saved').classList.toggle('hidden', tab !== 'saved');
        };

        window.handleImageSelect = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (ev) => {
                // Compress logic (Simple canvas resize)
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    const max = 800; 
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > max) { h *= max/w; w = max; } } else { if(h > max) { w *= max/h; h = max; } }
                    c.width = w; c.height = h;
                    c.getContext('2d').drawImage(img, 0, 0, w, h);
                    selectedImageBase64 = c.toDataURL('image/jpeg', 0.7);
                    document.getElementById('image-preview').src = selectedImageBase64;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(file);
        };
        
        window.clearImage = () => {
            selectedImageBase64 = null;
            document.getElementById('image-input').value = "";
            document.getElementById('image-preview-container').classList.add('hidden');
        };

        // Navigation & Modals logic (Copied from previous robust version)
        window.backToSidebar = () => { document.getElementById('sidebar').classList.remove('hidden'); document.getElementById('chat-area').classList.add('hidden'); currentChatId = null; };
        window.showCreateGroupModal = () => document.getElementById('create-group-modal').classList.remove('hidden');
        window.showAddFriendModal = () => document.getElementById('add-friend-modal').classList.remove('hidden');
        window.closeModals = () => { document.getElementById('add-friend-modal').classList.add('hidden'); document.getElementById('create-group-modal').classList.add('hidden'); document.getElementById('group-settings-modal').classList.add('hidden'); };

        window.createGroup = async () => {
            const name = document.getElementById('group-name').value.trim();
            const category = document.getElementById('group-category').value;
            const isPublic = document.getElementById('group-public').checked;
            if(!name) return;
            await addDoc(collection(db, "chats"), {
                name, type: 'group', category, isPublic,
                participants: [currentUser.uid], admins: [currentUser.uid],
                onlyAdminsCanPost: false,
                lastUpdated: serverTimestamp(),
                userDetails: { [currentUser.uid]: {name:currentUser.displayName, photo:currentUser.photoURL} }
            });
            closeModals();
            switchTab('groups');
        };

        window.startChat = async () => {
            const email = document.getElementById('friend-email').value.trim();
            if(!email) return;
            const q = query(collection(db, "users"), where("email", "==", email));
            const snap = await getDocs(q);
            if(snap.empty) return alert("User not found");
            const friend = snap.docs[0].data();
            const chatId = [currentUser.uid, friend.uid].sort().join('_');
            await setDoc(doc(db, "chats", chatId), {
                participants: [currentUser.uid, friend.uid], type: 'direct', lastUpdated: serverTimestamp(),
                userDetails: { [currentUser.uid]: {name:currentUser.displayName, photo:currentUser.photoURL}, [friend.uid]: {name:friend.displayName, photo:friend.photoURL} }
            }, { merge: true });
            closeModals();
            selectChat(chatId, {name: friend.displayName, photo: friend.photoURL});
        };

        document.getElementById("message-input").addEventListener("keypress", (e) => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });

    </script>
</body>
</html>
