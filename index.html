<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kix Chat v3</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --accent-primary: #f43f5e;
            --msg-sent: #f43f5e;
            --msg-received: #334155;
        }

        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-dark); color: #f8fafc; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .chat-bubble { max-width: 75%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
        .sent { background-color: var(--msg-sent); color: white; border-bottom-right-radius: 2px; align-self: flex-end; }
        .received { background-color: var(--msg-received); color: white; border-bottom-left-radius: 2px; align-self: flex-start; }
        
        /* Sticker Style */
        .sticker-msg { background: transparent !important; padding: 0 !important; font-size: 4rem; box-shadow: none !important; }
        .sticker-bounce { animation: bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .chat-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .chat-item.active { background-color: rgba(244, 63, 94, 0.1); border-left: 3px solid #f43f5e; }

        .unread-badge { background: #22c55e; color: black; font-weight: bold; font-size: 10px; padding: 2px 6px; border-radius: 999px; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Glassmorphism for Tour */
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-[#0f172a] p-6">
        <div class="text-center max-w-sm w-full space-y-6 fade-in">
            <div class="flex justify-center mb-4">
                <div class="w-20 h-20 bg-gradient-to-tr from-rose-500 to-orange-500 rounded-2xl flex items-center justify-center shadow-2xl shadow-rose-500/30">
                    <i class="ph-fill ph-chat-teardrop-text text-4xl text-white"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold">Kix Chat</h1>
            <p class="text-slate-400 text-sm">Professional Messaging for Teams</p>
            
            <button onclick="signInWithGoogle()" class="w-full bg-white text-slate-900 font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 transition-all shadow-lg group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- WELCOME TOUR MODAL (First Time Users) -->
    <div id="tour-modal" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 fade-in">
        <div class="glass-panel max-w-md w-full rounded-2xl p-8 text-center relative overflow-hidden">
            <!-- Decorative blobs -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-rose-500/20 rounded-full blur-2xl"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-blue-500/20 rounded-full blur-2xl"></div>

            <div class="relative z-10">
                <div class="w-16 h-16 bg-gradient-to-br from-rose-400 to-orange-400 rounded-xl mx-auto flex items-center justify-center mb-6 shadow-lg shadow-rose-500/20">
                    <i class="ph-bold ph-sparkle text-3xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Welcome to Kix Chat!</h2>
                <p class="text-slate-300 mb-6 text-sm leading-relaxed">
                    You've joined the most secure and professional chat platform. Here's what you can do:
                </p>

                <div class="space-y-4 text-left mb-8">
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="ph-fill ph-user-plus text-rose-400 text-xl"></i>
                        <div>
                            <div class="font-medium text-sm">Add Friends Easily</div>
                            <div class="text-xs text-slate-400">Just use their Gmail address to connect.</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="ph-fill ph-sticker text-rose-400 text-xl"></i>
                        <div>
                            <div class="font-medium text-sm">Express with Stickers</div>
                            <div class="text-xs text-slate-400">Send fun, large stickers to liven up chats.</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="ph-fill ph-lock-key text-rose-400 text-xl"></i>
                        <div>
                            <div class="font-medium text-sm">Secure & Fast</div>
                            <div class="text-xs text-slate-400">Real-time messaging with image compression.</div>
                        </div>
                    </div>
                </div>

                <button onclick="closeTour()" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-semibold py-3 rounded-xl transition-all shadow-lg shadow-rose-500/20">
                    Get Started üöÄ
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-interface" class="hidden flex-1 flex h-full relative">
        
        <!-- SIDEBAR (Chat List) -->
        <div class="w-full md:w-80 bg-[#1e293b] border-r border-slate-700/30 flex flex-col z-20" id="sidebar">
            <!-- Header -->
            <div class="p-4 border-b border-slate-700/30 flex justify-between items-center bg-[#1e293b] shrink-0">
                <div class="flex items-center gap-3">
                    <img id="my-avatar" src="" class="w-9 h-9 rounded-full border border-slate-600">
                    <div>
                        <h2 class="font-bold text-sm">Chats</h2>
                        <div class="flex items-center gap-1 text-[10px] text-green-400">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Online
                        </div>
                    </div>
                </div>
                <button onclick="showAddFriendModal()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-rose-500 hover:text-white flex items-center justify-center transition-colors shadow-md" title="Add New Chat">
                    <i class="ph-bold ph-plus"></i>
                </button>
            </div>

            <!-- Chat List Container -->
            <div id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center text-slate-500 text-xs mt-10">Loading conversations...</div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="flex-1 flex flex-col bg-[#0f172a] relative hidden md:flex h-full overflow-hidden" id="chat-area">
            
            <!-- Empty State -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500">
                <i class="ph-duotone ph-chats-circle text-6xl mb-4 text-slate-700"></i>
                <p>Select a conversation to start chatting</p>
            </div>

            <!-- Active Chat Interface -->
            <div id="active-chat-interface" class="hidden flex-col h-full w-full">
                <!-- Chat Header (Fixed) -->
                <div class="h-16 border-b border-slate-700/30 flex items-center justify-between px-4 bg-[#1e293b]/50 backdrop-blur-md shrink-0 z-10">
                    <div class="flex items-center gap-3">
                        <button onclick="backToSidebar()" class="md:hidden text-slate-400"><i class="ph-bold ph-arrow-left text-xl"></i></button>
                        <img id="chat-header-img" src="" class="w-8 h-8 rounded-full bg-slate-700">
                        <h3 id="chat-header-name" class="font-bold text-sm text-white">User</h3>
                    </div>
                    <button class="text-slate-400 hover:text-white"><i class="ph-bold ph-dots-three-vertical text-xl"></i></button>
                </div>

                <!-- Messages (Scrollable Area) -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 flex flex-col min-h-0">
                    <!-- Messages go here -->
                </div>

                <!-- Input Area (Fixed Bottom) -->
                <div class="p-3 bg-[#1e293b] border-t border-slate-700/30 shrink-0 relative z-20">
                    
                    <!-- Sticker Picker (Hidden by default) -->
                    <div id="sticker-picker" class="hidden absolute bottom-full left-4 mb-2 bg-[#1e293b] border border-slate-700 rounded-xl shadow-2xl p-3 w-64 grid grid-cols-4 gap-2 z-50 animate-bounce-in origin-bottom-left">
                        <!-- Stickers -->
                        <button onclick="sendSticker('üëª')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üëª</button>
                        <button onclick="sendSticker('üî•')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üî•</button>
                        <button onclick="sendSticker('‚ù§Ô∏è')" class="text-3xl hover:bg-white/10 p-2 rounded transition">‚ù§Ô∏è</button>
                        <button onclick="sendSticker('üòÇ')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üòÇ</button>
                        <button onclick="sendSticker('üëç')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üëç</button>
                        <button onclick="sendSticker('üöÄ')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üöÄ</button>
                        <button onclick="sendSticker('üéâ')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üéâ</button>
                        <button onclick="sendSticker('üëÄ')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üëÄ</button>
                        <button onclick="sendSticker('üí©')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üí©</button>
                        <button onclick="sendSticker('üíÄ')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üíÄ</button>
                        <button onclick="sendSticker('üíØ')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üíØ</button>
                        <button onclick="sendSticker('üëã')" class="text-3xl hover:bg-white/10 p-2 rounded transition">üëã</button>
                    </div>

                    <!-- Image Preview -->
                    <div id="image-preview-container" class="hidden mb-2 p-2 bg-slate-800 rounded-lg w-fit relative">
                        <img id="image-preview" src="" class="h-16 rounded border border-slate-600">
                        <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5"><i class="ph-bold ph-x text-xs"></i></button>
                    </div>

                    <div class="flex items-center gap-2 max-w-4xl mx-auto">
                        <!-- Sticker Button -->
                        <button onclick="toggleStickerPicker()" class="p-2 text-slate-400 hover:text-yellow-400 transition-colors" title="Stickers">
                            <i class="ph-fill ph-smiley text-2xl"></i>
                        </button>

                        <!-- Image Button -->
                        <label class="p-2 text-slate-400 hover:text-rose-500 cursor-pointer transition-colors" title="Send Image">
                            <i class="ph-bold ph-image text-2xl"></i>
                            <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                        </label>

                        <!-- Text Input -->
                        <input id="message-input" type="text" class="flex-1 bg-[#0f172a] border border-slate-600 rounded-full px-4 py-3 text-sm text-white focus:border-rose-500 outline-none transition-all placeholder-slate-500" placeholder="Type a message...">
                        
                        <!-- Send Button -->
                        <button onclick="sendMessage()" id="send-btn" class="w-11 h-11 bg-rose-500 hover:bg-rose-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-95">
                            <i class="ph-fill ph-paper-plane-right text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD FRIEND MODAL -->
    <div id="add-friend-modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1e293b] rounded-2xl p-6 w-full max-w-sm border border-slate-700 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">New Chat</h3>
            <input type="email" id="friend-email" placeholder="Enter friend's Gmail address" class="w-full bg-[#0f172a] border border-slate-600 rounded-lg p-3 text-white mb-4 text-sm focus:border-rose-500 outline-none">
            <div class="flex gap-2 justify-end">
                <button onclick="document.getElementById('add-friend-modal').classList.add('hidden')" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
                <button onclick="startChat()" class="px-4 py-2 bg-rose-500 hover:bg-rose-600 text-white rounded-lg text-sm font-medium">Start Chat</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, query, where, getDocs, onSnapshot, serverTimestamp, updateDoc, increment, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCz8xJ5Qb7m5cjYWs9SqxpdtnZymYLiblI",
            authDomain: "kix-chatmass.firebaseapp.com",
            projectId: "kix-chatmass",
            storageBucket: "kix-chatmass.firebasestorage.app",
            messagingSenderId: "796961974964",
            appId: "1:796961974964:web:65c536e2a521b28e56c5e1",
            measurementId: "G-CPZC0E6HD7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // State
        let currentUser = null;
        let currentChatId = null;
        let selectedImageBase64 = null;
        let unsubscribeMessages = null;

        // --- AUTH LOGIC ---
        window.signInWithGoogle = () => {
            signInWithPopup(auth, provider).catch((error) => alert(error.message));
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('my-avatar').src = user.photoURL;

                // Save/Update User in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    lastSeen: serverTimestamp()
                }, { merge: true });

                // Check for Tour
                if (!localStorage.getItem('kix_tour_seen')) {
                    document.getElementById('tour-modal').classList.remove('hidden');
                }

                loadChats();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
        });

        window.closeTour = () => {
            document.getElementById('tour-modal').classList.add('hidden');
            localStorage.setItem('kix_tour_seen', 'true');
        }

        // --- STICKER LOGIC ---
        window.toggleStickerPicker = () => {
            document.getElementById('sticker-picker').classList.toggle('hidden');
        }
        
        window.sendSticker = (emoji) => {
            sendMessage(emoji, 'sticker');
            toggleStickerPicker();
        }

        // Hide sticker picker when clicking outside
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('sticker-picker');
            const btn = document.querySelector('button[title="Stickers"]');
            if (!picker.contains(e.target) && !btn.contains(e.target)) {
                picker.classList.add('hidden');
            }
        });

        // --- SIDEBAR LOGIC (CHAT LIST) ---
        function loadChats() {
            const chatsRef = collection(db, "chats");
            const q = query(chatsRef, where("participants", "array-contains", currentUser.uid));

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("chat-list");
                list.innerHTML = "";
                
                let chats = [];
                snapshot.forEach(doc => {
                    chats.push({ id: doc.id, ...doc.data() });
                });

                chats.sort((a, b) => (b.lastUpdated?.toMillis() || 0) - (a.lastUpdated?.toMillis() || 0));

                if(chats.length === 0) {
                    list.innerHTML = `<div class="text-center mt-5 text-slate-500 text-xs">No chats yet.<br>Click + to add a friend.</div>`;
                    return;
                }

                chats.forEach(chat => {
                    const otherUserId = chat.participants.find(uid => uid !== currentUser.uid);
                    const otherUserInfo = chat.userDetails ? chat.userDetails[otherUserId] : { name: 'User', photo: '' };
                    
                    const unreadCount = chat.unreadCounts ? (chat.unreadCounts[currentUser.uid] || 0) : 0;
                    let lastMsg = chat.lastMessage || "No messages yet";
                    
                    // Formatting last message
                    if (chat.lastMessageType === 'image') lastMsg = '<i class="ph-bold ph-image"></i> Photo';
                    if (chat.lastMessageType === 'sticker') lastMsg = '<i class="ph-bold ph-sticker"></i> Sticker';
                    
                    // Time formatting
                    let timeStr = "";
                    if(chat.lastUpdated) {
                        const date = chat.lastUpdated.toDate();
                        const now = new Date();
                        if(date.toDateString() === now.toDateString()) {
                            timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        } else {
                            timeStr = date.toLocaleDateString();
                        }
                    }

                    const div = document.createElement('div');
                    div.className = `chat-item p-3 rounded-xl cursor-pointer flex items-center gap-3 transition-colors ${currentChatId === chat.id ? 'active' : ''}`;
                    div.onclick = () => selectChat(chat.id, otherUserInfo);
                    
                    div.innerHTML = `
                        <img src="${otherUserInfo.photo || 'https://ui-avatars.com/api/?name='+otherUserInfo.name}" class="w-10 h-10 rounded-full bg-slate-700 object-cover">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <h4 class="font-medium text-sm truncate text-white">${otherUserInfo.name}</h4>
                                <span class="text-[10px] text-slate-500">${timeStr}</span>
                            </div>
                            <div class="flex justify-between items-center mt-0.5">
                                <p class="text-xs text-slate-400 truncate w-32 ${unreadCount > 0 ? 'font-bold text-white' : ''}">
                                    ${lastMsg}
                                </p>
                                ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.showAddFriendModal = () => document.getElementById('add-friend-modal').classList.remove('hidden');

        window.startChat = async () => {
            const email = document.getElementById('friend-email').value.trim();
            if(!email) return;

            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty) {
                alert("User not found! Ask them to log in to Kix Chat first.");
                return;
            }

            const friendUser = querySnapshot.docs[0].data();
            if(friendUser.uid === currentUser.uid) {
                alert("You can't chat with yourself!");
                return;
            }

            const chatParticipants = [currentUser.uid, friendUser.uid].sort();
            const chatId = `${chatParticipants[0]}_${chatParticipants[1]}`;
            const chatDocRef = doc(db, "chats", chatId);
            
            await setDoc(chatDocRef, {
                participants: chatParticipants,
                lastUpdated: serverTimestamp(),
                userDetails: {
                    [currentUser.uid]: { name: currentUser.displayName, photo: currentUser.photoURL },
                    [friendUser.uid]: { name: friendUser.displayName, photo: friendUser.photoURL }
                },
                unreadCounts: {
                    [currentUser.uid]: 0,
                    [friendUser.uid]: 0
                }
            }, { merge: true });

            document.getElementById('add-friend-modal').classList.add('hidden');
            document.getElementById('friend-email').value = "";
            selectChat(chatId, { name: friendUser.displayName, photo: friendUser.photoURL });
        };

        // --- CHAT AREA LOGIC ---
        function selectChat(chatId, otherUserInfo) {
            currentChatId = chatId;

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('active-chat-interface').classList.remove('hidden');
            
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('chat-area').classList.remove('hidden');
                document.getElementById('chat-area').classList.add('flex');
            }

            document.getElementById('chat-header-name').innerText = otherUserInfo.name;
            document.getElementById('chat-header-img').src = otherUserInfo.photo || `https://ui-avatars.com/api/?name=${otherUserInfo.name}`;

            const chatRef = doc(db, "chats", chatId);
            updateDoc(chatRef, { [`unreadCounts.${currentUser.uid}`]: 0 });

            if(unsubscribeMessages) unsubscribeMessages();
            
            const msgsRef = collection(db, "chats", chatId, "messages");
            const q = query(msgsRef, orderBy("createdAt", "asc"));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const container = document.getElementById("messages-container");
                container.innerHTML = "";
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === currentUser.uid;
                    
                    const div = document.createElement('div');
                    div.className = `flex flex-col mb-2 ${isMe ? 'items-end' : 'items-start'}`;
                    
                    let content = "";
                    
                    // Render Sticker
                    if (msg.type === 'sticker') {
                        content = `<div class="sticker-msg sticker-bounce">${msg.text}</div>`;
                    } 
                    // Render Image
                    else if(msg.imageUrl) {
                        content += `<div class="chat-bubble ${isMe ? 'sent' : 'received'}"><img src="${msg.imageUrl}" class="rounded-lg mb-1 max-w-[200px] border border-slate-600 cursor-pointer" onclick="window.open(this.src)"></div>`;
                    }
                    // Render Text
                    else if(msg.text) {
                        content += `<div class="chat-bubble ${isMe ? 'sent' : 'received'}"><p>${msg.text}</p></div>`;
                    }

                    // Time
                    const time = msg.createdAt ? msg.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

                    div.innerHTML = `
                        ${content}
                        <div class="text-[9px] ${isMe ? 'text-white/70' : 'text-slate-500'} text-right mt-1 mr-1">${time}</div>
                    `;
                    container.appendChild(div);
                });
                
                container.scrollTop = container.scrollHeight;
            });
        }

        window.backToSidebar = () => {
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('chat-area').classList.add('hidden');
            currentChatId = null;
        }

        // --- SEND MESSAGE ---
        window.sendMessage = async (content = null, type = 'text') => {
            if(!currentChatId) return;
            
            const input = document.getElementById('message-input');
            const text = content || input.value.trim();
            const btn = document.getElementById('send-btn');

            if(!text && !selectedImageBase64) return;

            if(type === 'text') {
                btn.disabled = true;
                input.value = "";
            }

            try {
                const messagesRef = collection(db, "chats", currentChatId, "messages");
                await addDoc(messagesRef, {
                    text: text,
                    imageUrl: selectedImageBase64,
                    senderId: currentUser.uid,
                    type: selectedImageBase64 ? 'image' : type,
                    createdAt: serverTimestamp()
                });

                const p = currentChatId.split('_');
                const otherUid = p.find(id => id !== currentUser.uid);
                const chatRef = doc(db, "chats", currentChatId);

                await updateDoc(chatRef, {
                    lastMessage: type === 'sticker' ? 'Sticker' : (text || "Photo"),
                    lastMessageType: selectedImageBase64 ? 'image' : type,
                    lastUpdated: serverTimestamp(),
                    [`unreadCounts.${otherUid}`]: increment(1)
                });

                if (selectedImageBase64) clearImage();
                btn.disabled = false;
                if(type === 'text') input.focus();

            } catch(e) {
                console.error(e);
                btn.disabled = false;
            }
        };

        // --- IMAGE HANDLING ---
        window.handleImageSelect = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600;
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('image-preview').src = selectedImageBase64;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.clearImage = () => {
            selectedImageBase64 = null;
            document.getElementById('image-input').value = "";
            document.getElementById('image-preview-container').classList.add('hidden');
        };

        document.getElementById("message-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

    </script>
</body>
</html>
