<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kix Chat - Calls Enabled</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- ZEGOCLOUD SDK -->
    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <style>
        :root { --bg-dark: #0f172a; --bg-panel: #1e293b; --accent: #f43f5e; }
        
        body { 
            font-family: 'Outfit', 'Segoe UI Emoji', sans-serif; 
            background: var(--bg-dark); 
            color: #f8fafc; 
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            user-select: none; 
        }
        
        #app-container { display: flex; flex: 1; height: 100%; overflow: hidden; position: relative; }
        
        /* Zego Container */
        #zego-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
        }

        /* Loading */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #f43f5e; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI Elements */
        #sidebar { z-index: 30; }
        .chat-item { cursor: pointer; transition: background 0.15s ease; position: relative; z-index: 10; -webkit-tap-highlight-color: transparent; }
        .chat-item:active { background-color: rgba(255, 255, 255, 0.1); }
        .chat-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .chat-item.active { background-color: rgba(244, 63, 94, 0.15); border-left: 3px solid #f43f5e; }

        .chat-bubble { max-width: 85%; padding: 6px 10px 8px 10px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { background: #f43f5e; color: white; border-bottom-right-radius: 0px; align-self: flex-end; }
        .received { background: #334155; color: white; border-bottom-left-radius: 0px; align-self: flex-start; }
        
        .msg-meta { float: right; margin-left: 8px; margin-top: 4px; display: flex; align-items: center; gap: 2px; font-size: 0.7rem; opacity: 0.8; height: 14px; line-height: 1; }
        .blur-content { filter: blur(6px); transition: filter 0.3s; cursor: pointer; }
        .blur-content:hover { filter: blur(0); }
        .privacy-lock { position: absolute; top: -6px; right: -6px; background: #0f172a; border-radius: 50%; padding: 2px; font-size: 10px; color: #f43f5e; z-index: 10; }
        
        .context-menu { position: fixed; z-index: 99999; background: #1e293b; border: 1px solid #334155; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 180px; overflow: hidden; }
        .context-item { padding: 12px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: #cbd5e1; font-size: 0.9rem; }
        .context-item:hover { background: #334155; color: white; }
        
        .tab-btn { flex: 1; text-align: center; padding: 12px; font-size: 14px; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { color: #f43f5e; border-bottom-color: #f43f5e; font-weight: 600; }
        
        .unread-badge { background: #22c55e; color: black; font-weight: bold; font-size: 10px; padding: 2px 6px; border-radius: 999px; min-width: 20px; text-align: center; box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
        .recording-pulse { animation: pulse-red 1.5s infinite; color: #f43f5e; }
        @keyframes pulse-red { 0% { text-shadow: 0 0 0 rgba(244, 63, 94, 0.7); } 70% { text-shadow: 0 0 10px rgba(244, 63, 94, 0); } 100% { text-shadow: 0 0 0 rgba(244, 63, 94, 0); } }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tick { font-size: 16px; }
        .tick.blue { color: #93c5fd; }
        .tick.gray { color: #cbd5e1; }
        .mention { color: #fbbf24; font-weight: bold; background: rgba(251, 191, 36, 0.1); padding: 0 2px; rounded: 4px; }
        
        /* Attachment Menu */
        #attachment-menu { position: absolute; bottom: 70px; left: 10px; background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideUp 0.2s ease-out; }
        .attach-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 70px; height: 60px; border-radius: 12px; background: #0f172a; color: #cbd5e1; font-size: 10px; gap: 4px; transition: 0.2s; }
        .attach-btn:hover { background: #334155; color: #f43f5e; }
        .attach-btn i { font-size: 24px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #floating-mention-btn { position: absolute; bottom: 85px; right: 20px; background: #ffffff; color: #f43f5e; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4); z-index: 40; cursor: pointer; animation: bounceIn 0.3s; font-size: 1.5rem; }
        @keyframes bounceIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Call Banner */
        #call-banner { background: linear-gradient(90deg, #059669, #10b981); color: white; padding: 8px 16px; border-radius: 12px; margin: 10px; display: flex; justify-content: space-between; align-items: center; animation: pulseCall 2s infinite; cursor: pointer; }
        @keyframes pulseCall { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="lightbox" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center hidden fade-in" onclick="this.classList.add('hidden')"><img id="lightbox-img" src="" class="max-w-full max-h-full p-2 object-contain"></div>
    <div id="msg-context-menu" class="context-menu hidden"></div>
    <div id="zego-container"></div>
    
    <div id="pwa-banner" class="hidden fixed top-0 left-0 w-full bg-gradient-to-r from-rose-600 to-orange-500 text-white p-2 text-xs flex justify-between items-center z-[200]">
        <span>Install Kix Chat app!</span><button onclick="installPWA()" class="bg-white text-rose-600 px-3 py-1 rounded-full font-bold">Install</button>
    </div>

    <!-- SPLASH & LOGIN -->
    <div id="splash-screen" class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-[#0f172a]">
        <div class="flex justify-center mb-6 animate-pulse"><img id="splash-logo" class="w-24 h-24 rounded-3xl shadow-2xl object-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
        <h1 class="text-2xl font-bold text-white tracking-widest mb-2">KIX CHAT</h1>
        <div class="flex gap-2 mt-4"><div class="w-2 h-2 bg-rose-500 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-rose-500 rounded-full animate-bounce delay-100"></div><div class="w-2 h-2 bg-rose-500 rounded-full animate-bounce delay-200"></div></div>
    </div>
    <div id="login-screen" class="hidden absolute inset-0 z-[90] flex flex-col items-center justify-center bg-[#0f172a] p-6">
        <div class="text-center w-full max-w-sm"><img id="login-logo" class="w-20 h-20 rounded-2xl mx-auto mb-6 shadow-2xl object-cover" src=""><h1 class="text-3xl font-bold mb-8">Kix Chat</h1>
            <button onclick="signInWithGoogle()" class="w-full bg-white text-black font-medium py-3 rounded-xl flex items-center justify-center gap-3 shadow-lg mb-4 hover:bg-gray-100 transition transform active:scale-95"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Sign in with Google</button>
        </div>
    </div>

    <!-- APP -->
    <div id="app-interface" class="hidden w-full h-full flex flex-col overflow-hidden relative">
        <div class="flex flex-1 h-full overflow-hidden relative">
            <!-- Sidebar -->
            <div id="sidebar" class="w-full md:w-80 bg-[#1e293b] border-r border-slate-700/30 flex flex-col h-full flex-none transition-all duration-300">
                <div class="p-4 bg-[#1e293b] shrink-0 space-y-3 shadow-md z-20">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3 cursor-pointer p-1 rounded hover:bg-white/5" onclick="openSettings()">
                            <img id="my-avatar" src="" class="w-10 h-10 rounded-full border border-slate-600 object-cover">
                            <div><h2 class="font-bold text-sm" id="sidebar-title" onclick="event.stopPropagation(); toggleGhostMode()">Kix Chat</h2><div class="text-[10px] text-green-400">‚óè Online</div></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openSettings()" class="p-2 bg-slate-700 rounded-full hover:bg-rose-500 transition" title="Settings"><i class="ph-bold ph-gear"></i></button>
                            <button onclick="openModal('create-group-modal')" class="p-2 bg-slate-700 rounded-full hover:bg-rose-500 transition"><i class="ph-bold ph-users-three"></i></button>
                            <button onclick="openModal('add-friend-modal')" class="p-2 bg-slate-700 rounded-full hover:bg-rose-500 transition"><i class="ph-bold ph-plus"></i></button>
                        </div>
                    </div>
                    <div class="relative"><i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-slate-500"></i><input type="text" id="search-input" placeholder="Search Group ID (e.g. #G-123)" class="w-full bg-[#0f172a] rounded-lg pl-9 pr-3 py-2 text-xs text-white border border-slate-700 focus:border-rose-500 outline-none" onkeyup="handleSearch(event)"></div>
                    <div class="flex border-b border-slate-700/50"><div id="tab-chats" onclick="switchTab('chats')" class="tab-btn active">Chats</div><div id="tab-groups" onclick="switchTab('groups')" class="tab-btn">Groups</div></div>
                </div>
                <div id="list-container" class="flex-1 overflow-y-auto p-2 space-y-1 relative z-10 pb-20"><div class="mt-10 text-center"><div class="loader"></div></div></div>
            </div>

            <!-- Chat Area -->
            <div id="chat-area" class="flex-1 flex flex-col bg-[#0f172a] relative hidden md:flex h-full min-w-0">
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500"><i class="ph-duotone ph-chats-circle text-6xl mb-4"></i><p>Select a chat</p></div>
                <div id="active-chat-ui" class="hidden flex flex-col h-full w-full relative">
                    <div class="h-16 border-b border-slate-700/30 flex items-center justify-between px-4 bg-[#1e293b]/95 backdrop-blur shrink-0 z-10 cursor-pointer shadow-sm" onclick="showChatInfo()">
                        <div class="flex items-center gap-3 overflow-hidden"><button onclick="event.stopPropagation(); closeChat()" class="md:hidden text-slate-400 p-2 -ml-2 rounded-full hover:bg-slate-700"><i class="ph-bold ph-arrow-left text-xl"></i></button><img id="chat-header-img" src="" class="w-9 h-9 rounded-full bg-slate-700 shrink-0 object-cover"><div class="min-w-0"><h3 id="chat-header-name" class="font-bold text-sm text-white truncate">User</h3><p id="chat-header-status" class="text-[10px] text-slate-400 truncate">Tap for info</p></div></div>
                        <div class="flex gap-2 items-center">
                             <!-- CALL BUTTONS -->
                             <button onclick="event.stopPropagation(); startCall('audio')" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700"><i class="ph-bold ph-phone text-xl"></i></button>
                             <button onclick="event.stopPropagation(); startCall('video')" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700"><i class="ph-bold ph-video-camera text-xl"></i></button>
                             
                             <button onclick="event.stopPropagation(); openNotes()" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700"><i class="ph-bold ph-notepad text-xl"></i></button>
                             <button onclick="showChatInfo()" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700"><i class="ph-bold ph-info text-xl"></i></button>
                        </div>
                    </div>
                    <div id="disabled-banner" class="hidden bg-red-900/50 text-red-200 text-xs text-center py-1 border-b border-red-800">üö´ This group has been disabled</div>
                    
                    <!-- Call Banner (Join) -->
                    <div id="active-call-banner" class="hidden">
                        <div id="call-banner" onclick="joinCall()">
                            <div class="flex items-center gap-2"><i class="ph-fill ph-video-camera text-xl"></i> <span>Ongoing Call...</span></div>
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-bold">JOIN</span>
                        </div>
                    </div>

                    <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 flex flex-col w-full pb-20 scroll-smooth"></div>
                    <div id="floating-mention-btn" class="hidden" onclick="scrollToMention()"><i class="ph-bold ph-at"></i></div>

                    <!-- Input -->
                    <div id="input-area-wrapper" class="p-2 bg-[#1e293b] border-t border-slate-700/30 shrink-0 w-full z-20 relative">
                        <div id="mention-popup" class="hidden"></div>
                        <div id="admin-only-banner" class="hidden text-center text-xs text-rose-400 py-1 bg-rose-900/20 rounded mb-1">Only admins can send messages</div>
                        <div id="reply-banner" class="hidden flex justify-between items-center bg-slate-800 p-2 rounded mb-2 border-l-4 border-rose-500"><div class="text-xs overflow-hidden"><div class="text-rose-400 font-bold">Replying to...</div><div id="reply-text" class="text-slate-300 truncate"></div></div><button onclick="cancelReply()" class="p-1"><i class="ph-bold ph-x"></i></button></div>
                        <div id="schedule-info" class="hidden text-xs text-yellow-400 flex items-center gap-1 bg-yellow-400/10 px-2 py-1 rounded mb-2 w-fit"><i class="ph-fill ph-clock"></i> Scheduled: <span id="schedule-time-display"></span> <button onclick="cancelSchedule()"><i class="ph-bold ph-x"></i></button></div>
                        <div id="editing-indicator" class="hidden text-xs text-blue-400 mb-1 flex justify-between"><span>Editing Message...</span> <button onclick="cancelEdit()"><i class="ph-bold ph-x"></i></button></div>
                        <div id="image-preview-container" class="hidden mb-2 p-2 bg-slate-800 rounded-lg w-fit relative"><img id="image-preview" src="" class="h-14 rounded border border-slate-600"><button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5"><i class="ph-bold ph-x text-xs"></i></button></div>

                        <!-- Attachment Menu -->
                        <div id="attachment-menu" class="hidden">
                            <label class="attach-btn cursor-pointer"><i class="ph-bold ph-image text-blue-400"></i>Image<input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImage(event)"></label>
                            <button onclick="openPollModal(); toggleAttachmentMenu()" class="attach-btn"><i class="ph-bold ph-chart-bar text-green-400"></i>Poll</button>
                            <button onclick="promptSchedule(); toggleAttachmentMenu()" class="attach-btn"><i class="ph-bold ph-clock text-yellow-400"></i>Schedule</button>
                            <button onclick="togglePrivacy(); toggleAttachmentMenu()" class="attach-btn"><i class="ph-bold ph-lock-key text-red-400" id="menu-lock-icon"></i>Privacy</button>
                        </div>

                        <div id="main-controls" class="flex items-center gap-2">
                            <button onclick="toggleAttachmentMenu()" class="text-slate-400 hover:text-white p-1.5 rounded-full hover:bg-slate-800 transition bg-slate-800/50"><i class="ph-bold ph-plus text-xl"></i></button>
                            <input id="message-input" type="text" class="flex-1 bg-[#0f172a] rounded-full px-4 py-2 border border-slate-600 text-sm text-white focus:border-rose-500 outline-none transition" placeholder="Message or @mention...">
                            <button onclick="toggleStickerPicker()" class="text-slate-400 hover:text-yellow-400 p-1.5 rounded-full hover:bg-slate-800 transition"><i class="ph-fill ph-smiley text-xl"></i></button>
                            <button id="mic-btn" onclick="toggleSpeech()" class="text-slate-400 hover:text-green-400 p-1.5 rounded-full hover:bg-slate-800 transition"><i class="ph-bold ph-microphone text-xl"></i></button>
                            <button onclick="sendMessage()" class="p-2 bg-rose-500 rounded-full text-white shadow-lg active:scale-95 transition hover:bg-rose-600"><i class="ph-fill ph-paper-plane-right text-lg"></i></button>
                        </div>
                    </div>
                    <!-- Sticker Picker (Hidden) -->
                    <div id="sticker-picker" class="hidden absolute bottom-16 right-2 bg-[#1e293b] border border-slate-700 rounded-xl shadow-2xl p-3 w-72 h-80 overflow-y-auto z-50">
                        <!-- Same as before -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Settings, Notes, Poll, etc. kept from v13) -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-[#1e293b] p-6 rounded-2xl w-full max-w-sm border border-slate-700 relative text-center">
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6">Settings</h3>
            <div class="relative w-24 h-24 mx-auto mb-6 group cursor-pointer">
                <img id="settings-preview" src="" class="w-full h-full rounded-full border-4 border-slate-600 object-cover">
                <label class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition"><i class="ph-bold ph-camera text-2xl"></i><input type="file" class="hidden" accept="image/*" onchange="handleProfileImageSelect(event)"></label>
            </div>
            <div class="space-y-4 text-left">
                <div><label class="text-xs text-slate-400 block mb-1">Set Security PIN</label><div class="flex gap-2"><input type="text" id="settings-pin" placeholder="0000" maxlength="4" class="flex-1 bg-[#0f172a] rounded px-3 py-2 text-center text-lg tracking-widest border border-slate-600 outline-none"><button onclick="savePin()" class="bg-rose-500 text-white px-4 rounded text-sm">Save</button></div></div>
                <div><label class="text-xs text-slate-400 block mb-1">Auto-Reply</label><div class="flex gap-2"><input type="text" id="auto-reply-text" placeholder="I'm busy..." class="flex-1 bg-[#0f172a] rounded px-3 py-2 text-sm border border-slate-600 outline-none"><button onclick="saveAutoReply()" class="bg-blue-600 text-white px-4 rounded text-sm">Set</button></div></div>
            </div>
        </div>
    </div>
    <!-- Include other modals (Notes, Poll, Ghost, Join, Create, Forward, Admin, Add Friend) from v13 here -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, query, where, getDocs, onSnapshot, serverTimestamp, updateDoc, arrayUnion, arrayRemove, orderBy, getDoc, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- ZEGOCLOUD CONFIG ---
        // REPLACE THESE WITH YOUR KEYS FROM ZEGOCLOUD CONSOLE
        const ZEGO_APP_ID = 910816597; 
        const ZEGO_SERVER_SECRET = "31464886a069743631dcee8d496d2a98"; 

        const firebaseConfig = { apiKey: "AIzaSyCz8xJ5Qb7m5cjYWs9SqxpdtnZymYLiblI", authDomain: "kix-chatmass.firebaseapp.com", projectId: "kix-chatmass", storageBucket: "kix-chatmass.firebasestorage.app", messagingSenderId: "796961974964", appId: "1:796961974964:web:65c536e2a521b28e56c5e1", measurementId: "G-CPZC0E6HD7" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // [Standard Variables from v13...]
        let currentUser = null;
        let currentChatId = null;
        let currentChatData = null;
        let unsubscribeMessages = null;
        let unsubscribeChatData = null;
        let currentTab = 'chats';
        let replyToMsg = null;
        let tempJoinData = null;
        let scheduledTime = null;
        let isPrivacyMode = false;
        let recognition = null;
        let editingMessageId = null;
        let selectedImageBase64 = null;
        let deferredPrompt;
        let currentMessages = [];
        let forwardData = null; 
        let pendingMentionId = null;
        let newProfilePicBase64 = null;
        let myLastSeenTime = 0;
        let ghostsVisible = false;
        let userPin = "0000";

        // [Standard Functions from v13: generateAppLogo, PWA, Auth, Navigation, Lists, Chat Items...]
        // (Copy ALL Logic from v13 script block here - omitted for brevity in response, ensure full copy)

        // --- CALL LOGIC ---
        
        window.startCall = async (type) => {
            if (!ZEGO_APP_ID || !ZEGO_SERVER_SECRET) return alert("Please set ZegoCloud keys in code!");
            // Update Firebase to signal call
            await updateDoc(doc(db, "chats", currentChatId), {
                callState: {
                    isActive: true,
                    type: type,
                    initiator: currentUser.uid,
                    timestamp: Date.now()
                }
            });
            joinZegoRoom(currentChatId, type);
        };

        window.joinCall = () => {
             if(currentChatData.callState) joinZegoRoom(currentChatId, currentChatData.callState.type);
        };

        function joinZegoRoom(roomID, type) {
             const zp = ZegoUIKitPrebuilt.create(
                 ZegoUIKitPrebuilt.generateKitTokenForTest(
                     ZEGO_APP_ID, 
                     ZEGO_SERVER_SECRET, 
                     roomID, 
                     currentUser.uid, 
                     currentUser.displayName
                 )
             );

             const container = document.getElementById('zego-container');
             container.style.display = 'block';

             zp.joinRoom({
                 container: container,
                 scenario: {
                    mode: type === 'video' ? ZegoUIKitPrebuilt.GroupCall : ZegoUIKitPrebuilt.GroupVoiceCall,
                 },
                 showPreJoinView: false,
                 onLeaveRoom: async () => {
                     container.style.display = 'none';
                     // If I am initiator, maybe clear call state? 
                     // For groups, usually we leave it active until last person leaves or timeout.
                     // Simple: If initiator leaves, clear it.
                     if (currentChatData.callState && currentChatData.callState.initiator === currentUser.uid) {
                         await updateDoc(doc(db, "chats", currentChatId), { callState: null });
                     }
                 }
             });
        }

        // Updated openChat to listen for calls
        async function openChat(id, name, photo) {
             // ... [Existing loading logic] ...
             currentChatId = id;
             // ... [UI logic] ...

             if(unsubscribeChatData) unsubscribeChatData();
             unsubscribeChatData = onSnapshot(doc(db, "chats", id), (docSnap) => {
                 if(docSnap.exists()) { 
                     currentChatData = docSnap.data();
                     // CHECK CALL STATE
                     const callBanner = document.getElementById('active-call-banner');
                     if(currentChatData.callState && currentChatData.callState.isActive) {
                         callBanner.classList.remove('hidden');
                     } else {
                         callBanner.classList.add('hidden');
                     }
                     // ... [Rest of logic]
                 }
             });
             
             // ... [Message Listener] ...
        }

        // [Rest of script from v13]
        
    </script>
</body>
</html>
